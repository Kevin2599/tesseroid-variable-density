\documentclass[extra]{gji}
%~ \documentclass[extra, referee]{gji}

\usepackage[utf8]{inputenc}
\usepackage{timet}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage{todonotes} % to make annotations on margins
%~ \usepackage[disable]{todonotes} % to disable annotations on margins

\usepackage{url}
\usepackage[pdftex,colorlinks=true]{hyperref}
\hypersetup{
    allcolors=blue,
}


\begin{document}

\title[Variable Density Tesseroids]{
    Gravitational field calculation in spherical coordinates using variable
    densities in depth
}
\author[S.R. Soler, A. Pesce, L. Uieda and M.E. Gimenez]{
    Santiado R. Soler$^{1,2}$, Agustina Pesce$^{1,2}$, Leonardo Uieda$^3$ and
    Mario E. Gimenez$^{1,2}$ \\
    $^1$CONICET, Argentina. e-mail: santiago.r.soler@gmail.com\\
    $^2$Instituto Geofísico Sismológico Volponi, Universidad Nacional de
    San Juan, Argentina\\
    $^3$Department of Geology and Geophysics, SOEST, University of Hawai‘i at
    M\={a}noa, Honolulu, Hawaii, USA
}


\maketitle

\begin{summary}
We present a new methodology to compute the gravitational fields generated by
any tesseroid whose density varies continuously in depth, i.e. a forward
gravity model in spherical coordinates for varying densities on the radial
direction.
It numerical approximates these gravitational fields through the
Gauss-Legendre Quadrature along with two discretization algorithms that
increase its accuracy by subdividing the tesseroid into smaller ones.
The first one is a preexisting adaptive discretization algorithm that reduces
the errors due to the distance between the tesseroid and the computation
point.
While the second one  is a new density-based discretization algorithm that
decreases the errors introduced by the variation of the density function.
The amount of discretizations made by each algorithm is indirectly controlled
by two predefined scalar values: the distance-size ratio $D$ for the former
and the delta ratio $\delta$ for the latter.
We have also obtained analytical solutions for a spherical shell with variable
density and compared them with the results of the numerical model in case of a
linear and an exponential density function.
These comparisons allowed to obtain default values for the distance-size and
the delta ratio in order to guarantee the accuracy of the forward model.
The resulting optimal values of $D$ for the gravity potential, the components
of its gradient and the Marussi tensor components are 1, 2 and 8,
respectively.
While a $\delta=0.2$ is needed for the computation of the gravitational
potential and its gradient components and a $\delta=0.01$ must be used for
the Marussi tensor components.
We have finally tested this new methodology by modelling the Neuqu\'en
sedimentary basin, located to the east of the Andes between 32$^\circ$S and
40$^\circ$S latitude, assigning an exponential density variation to it and
computing all the gravitational fields it generates.
\end{summary}

\begin{keywords}
Numerical modelling, Numerical approximations and analysis, Gravity anomalies
and Earth structure, Satellite gravity
\end{keywords}


\section{Introduction}

The lithosphere's density variation with depth has been studied for close to a
century.
Over this time period,
several density-depth relations have been proposed for different rock types
\citep[e.g.,][]{Maxant1980, Rao1986, Rao1993, Rao1994}.
Furthermore, depth-variable densities have been used in forward and
inverse gravity modeling, mostly applied to sedimentary basins
\citep{Cordell1973, Rao1986, Cowie1990, Rao1993, Rao1994, Zhang2001,
Welford2010}.
These forward gravity models have been developed for two or three dimensional
bodies in Cartesian coordinates, which limits the applications to local scales.
The advent of satellite gravimetry has provided gravity field
measurements with global coverage, enabling modelling and interpretation on regional and
global scales.
Hence, designing forward modeling methods that reproduce the gravity anomalies for
such scales is of high importance.

To take into account the curvature of the Earth, many global forward modeling methods
are defined in geocentric spherical coordinates.
A common approach is to discretize the Earth into tesseroids (spherical prisms),
which are defined by pairs of latitude, longitude, and
radial boundaries (see Fig.~\ref{fig:tesseroid}).
The gravitational fields generated by an arbitrary
tesseroid on any external point are given by volume
integrals that are generally approximated by numerically.
The literature offers two main approaches: one involves Taylor series expansion
\citep{Heck2007, Grombein2013} while the other makes use of Gauss-Legendre
Quadrature (GLQ)
\citep{Asgharzadeh2007, Wild-Pfeiffer2008, Li2011, Uieda2016}.
The Taylor series expansion is not well suited to develop an algorithm for
a density varying with depth according to an arbitrary function.
Different series expansion terms would have to obtained for each density function
desired.
Conversely, an arbitrary density function can be included in the GLQ without
any change to the integration method.

\begin{figure}
\centering
\includegraphics[width=0.9\linewidth]{figures/tesseroid-uieda.pdf}
\caption{
    A tesseroid (spherical prism) in a geocentric spherical coordinate system, with a
    computation point $P$ and its local north oriented Cartesian coordinate system.
    After \citet{Uieda2015}.
}
\label{fig:tesseroid}
\end{figure}

The main challenge of the GLQ integration is loss of accuracy when the computation point
gets closer to the tesseroid \citep{Ku1977}.
\citet{Uieda2016} built on the adaptive discretization algorithm of \citet{Li2011}
to automatically obtain integration results with 0.1\% accuracy.
The algorithm consist in recursively splitting the tesseroid into smaller ones when a
threshold is exceeded,
namely when the normalized distance to the computation point is greater than a
``distance-size ratio'' ($D$).
\citet{Uieda2016} have also obtained standard values of $D$
for the gravitational potential, acceleration, and gradient tensor components
by comparing the numerical model with the fields generated by a spherical shell.

We present a new algorithm for computing the gravitational fields generated by any
tesseroid with an arbitrary continuous density function on any external point.
It is based on the GLQ approximation and the adaptive discretization of
\citet{Uieda2016}, which we extend to include a new density-based discretization step.
In order to ensure the accuracy of the numerical approximation we have
determined optimal values for the controlling parameters by
comparing the numerical approximation with analytical solutions for
spherical shells.
Finally, we applied the methodology to model the Nequen basin, Argentina, using
tesseroids with an exponentially increasing density with depth.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Methodology}

We define an external computation point $P(r, \phi, \lambda)$ in a geocentric spherical
coordinate system at a radius $r$, geocentric latitude $\phi$, and longitude $\lambda$
where the gravitational fields are going to be calculated.
The first and second derivatives of the gravitational potential are taken with
respect to the local north-oriented Cartesian coordinate system of $P$
(Fig.~\ref{fig:tesseroid}).
\citet{Grombein2013} provide efficient formulations for the volume integrals of the
gravitational potential and its first and second derivatives of a tesseroid with
homogeneous density.
Here, we will assume that the tesseroid has a density varying with $r$ according to an
arbitrary function $\rho(r)$.
Thus, the integrals for the gravitational fields are slightly modified to

\begin{equation}
    V(r,\phi,\lambda) = G
    \int\limits_{\lambda_1}^{\lambda_2}
    \int\limits_{\phi_1}^{\phi_2}
    \int\limits_{r_1}^{r_2}
    \frac{\rho(r')}{\ell} \kappa \,  dr' d\phi' d\lambda',
\label{eq:tesseroid-pot}
\end{equation}

\begin{equation}
    g_{\alpha}(r,\phi,\lambda) = G
    \int\limits_{\lambda_1}^{\lambda_2}
    \int\limits_{\phi_1}^{\phi_2}
    \int\limits_{r_1}^{r_2}
    \rho(r') \frac{\Delta_\alpha}{\ell^3}
    \kappa \, dr' d\phi' d\lambda',
\label{eq:tesseroid-grav}
\end{equation}

\noindent and

\begin{equation}
    g_{\alpha\beta}(r,\phi,\lambda) = G
    \int\limits_{\lambda_1}^{\lambda_2}
    \int\limits_{\phi_1}^{\phi_2}
    \int\limits_{r_1}^{r_2}
    \rho(r') I_{\alpha\beta} \, \kappa \, dr' d\phi' d\lambda' ,
    \label{eq:tesseroid-tensor}
\end{equation}

\noindent in which

\begin{equation}
    I_{\alpha\beta} =
    \left(
        \frac{3\Delta_{\alpha} \Delta_{\beta}}{\ell^5} -
        \frac{\delta_{\alpha\beta}}{\ell^3}
    \right) ,
    \label{eq:tesseroid-tensor-kernel}
\end{equation}

\noindent $\alpha, \beta \in \{x, y, z\}$, $\delta_{\alpha\beta}$ is Kronecker's delta,
$G = 6.674\times10^{-11}\, \text{m$^3$kg$^{-1}$s$^{-1}$}$ is the gravitational constant
and

\begin{equation}
    \Delta_x = r'[\cos\phi\sin\phi' - \sin\phi\cos\phi'
               \cos(\lambda' - \lambda)],
\end{equation}
\begin{equation}
    \Delta_y = r' \cos \phi' \sin(\lambda' - \lambda),
\end{equation}
\begin{equation}
    \Delta_z = r' \cos \psi - r,
\end{equation}
\begin{equation}
    \kappa = {r'}^2 \cos \phi',
\end{equation}
\begin{equation}
    \ell = \sqrt{{r'}^2 + r^2 - 2 r r' \cos \psi},
\label{eq:ell}
\end{equation}
\begin{equation}
    \cos\psi = \sin\phi\sin\phi' + \cos\phi\cos\phi'
                 \cos(\lambda' - \lambda).
\label{eq:cospsi}
\end{equation}

\subsection{Gauss-Legendre Quadrature integration}

Applying a $N$th order GLQ, we can approximate each integral in equations
\ref{eq:tesseroid-pot}, \ref{eq:tesseroid-grav} and \ref{eq:tesseroid-tensor} by a
weighted sum of the integration kernel evaluated on the roots of an $N$th order Legendre
polynomial \citep[p.~390]{Hildebrand1987}.
Unlike the homogeneous density case, the radial density function $\rho(r)$ must also be
included in the integration and evaluated on the Legendre polynomial roots (i.e.,
quadrature nodes).

\iftwocol{
\begin{equation}
    \begin{split}
        \iiint\limits_\Omega \rho(r') g(r', \phi', \lambda')
        d\Omega \approx& \\
        A
        \sum\limits_{i=1}^{N^r}
        \sum\limits_{j=1}^{N^\phi}
        \sum\limits_{k=1}^{N^\lambda}
        & W_i^r W_j^\phi W_k^\lambda \rho(r_i) g(r_i, \phi_j, \lambda_k),
    \end{split}
\label{eq:glq-var-dens}
\end{equation}
}{
\begin{equation}
    \iiint\limits_\Omega \rho(r') g(r', \phi', \lambda') d\Omega \approx
    A
    \sum\limits_{i=1}^{N^r}
    \sum\limits_{j=1}^{N^\phi}
    \sum\limits_{k=1}^{N^\lambda}
    W_i^r W_j^\phi W_k^\lambda \rho(r_i) g(r_i, \phi_j, \lambda_k),
\label{eq:glq-var-dens}
\end{equation}
}

\noindent where

\begin{equation}
    A =
    \frac{(\lambda_2 - \lambda_1)(\phi_2 - \phi_1)(r_2 - r_1)}{8},
\end{equation}

\noindent $(r_i, \phi_j, \lambda_k)$ are the quadrature nodes, and $W_i^r$ are the
quadrature weights.


\subsection{Adaptive Discretization}

\citet{Ku1977} noticed that the GLQ integration
becomes less accurate when the computation point is closer to the
mass element.
One way to prevent this from happening would be to increase the GLQ order.
Doing so would uniformly increase the number of point masses inside the
tesseroid volume.
However, an increase in the point mass concentration is only required close to the
computation point \citep{Uieda2016}.
Alternatively, \citet{Li2011} proposed an adaptive
discretization algorithm which keeps the GLQ order fixed and divides the
tesseroid based on a ratio between the distance to the computation
point and its dimensions.
This algorithm produces a more efficient computation because an increased concentration
of point masses is produced where it is needed more.
\citet{Uieda2016} developed a modified version of this algorithm, which we will use
here.
What follows is a summary of the algorithm and the reader is referred to
\citet{Uieda2016} for a detailed description.

The following algorithm computes the gravitational fields at a given point at $(r, \phi,
\lambda)$ due to a tesseroid with its geometric center at $(r_t, \phi_t, \lambda_t)$ and
dimensions $L_r$, $L_\phi$, and $L_\lambda$ given by

\begin{equation}
    L_\lambda = r_2 \arccos(\sin^2\phi_t +
        \cos^2\phi_t\cos(\lambda_2 - \lambda_1)),
    \label{eq:sizelon}
\end{equation}

\begin{equation}
    L_\phi = r_2 \arccos(\sin\phi_2\sin\phi_1 + \cos\phi_2\cos\phi_1),
\end{equation}

and

\begin{equation}
    L_r = r_2 - r_1.
    \label{eq:sizer}
\end{equation}

\textit{Step 1}: Check that the tesseroid satisfies the following inequality for each
dimension $L_i$ of the tesseroid:

\begin{equation}
    \frac{d}{L_i} \geq D,
    \label{eq:condition}
\end{equation}

\noindent
in which $D$ is a positive scalar called the distance-size ratio and $d$ is the distance
between the computation point and the geometric center of the tesseroid

\begin{equation}
    d = \left[
        r^2 + r_t^2 - 2 r r_t \cos\psi_t
        \right]^{\frac{1}{2}} ,
    \label{eq:distance}
\end{equation}

\begin{equation}
    \cos\psi_t =
        \sin\phi\sin\phi_t + \cos\phi\cos\phi_t\cos(\lambda - \lambda_t) .
\end{equation}

\textit{Step 2}:
If none of the dimensions of the tesseroid fail inequality
\ref{eq:condition}, then compute the gravitational effect of the tesseroid using a
second-order GLQ (Eq. \ref{eq:glq-var-dens}).
Add the computed effect to a running total.

\textit{Step 3}:
If any dimension fails inequality \ref{eq:condition}, split the tesseroid in half along
the offending dimensions.
Repeat steps 1-3 for all smaller tesseroids until none are left.

\textit{Final step}:
By the end of the algorithm, the running total will be the gravitational effect of the
tesseroid.

Notice that the distance-size ratio $D$ determines how many
times the tesseroids will be divided.
Therefore, it effectively regulates both the accuracy of the algorithm and its
computation time.
An optimal value for $D$ cannot be directly calculated from the desired accuracy level.
Instead, it is empirically determined by comparing the numerical results with the
analytical solution for a spherical shell.
\citet{Uieda2016} used a shell with homogeneous density to determine optimal values of
$D$.
Here, we will repeat the numerical experiment using analytical expressions for shells
with density varying according to exponential and linear functions of $r$.


\subsection{Density-based Discretization Algorithm}

The numerical integration of an arbitrary density function introduces
a new type of problem:
the integration error from using only a few nodes to discretize the density function.
The adaptive discretization may help
to reduce this kind of error.
However, it does not take into account the density function
and hence it is not well suited to fully perform this task.

We have developed a complementary discretization
algorithm that takes into account the variations of the density function.
This density-based discretization happens prior to the adaptive discretization described
in the previous section.
In short, the algorithm divides the tesseroid along the radial dimension at the
depths at which the \emph{maximum density variations} take place.

Consider an \emph{original} tesseroid with density given by the function $\rho(r')$.
Before the density-based discretization starts,
we normalise the density function to the range $[0, 1]$ as follows

\begin{equation}
    \rho_n(r') =
    \frac{\rho(r') - \rho_\text{min}}{\rho_\text{max} - \rho_\text{min}},
\end{equation}

\noindent in which $\rho_\text{min}$ and $\rho_\text{max}$ are the minimum and maximum
density values inside the tesseroid boundaries.
We emphasize that this normalised density function will not be modified throughout the
algorithm.
In case the density function is constant, both maximum and minimum densities will be
equal and the density-based discretization algorithm will not be applied.

The algorithm is comprised of the following steps
(Fig. \ref{fig:density-discretization-algorithm}):

\textit{Step 1}:
Define a linear function $\rho_l(r')$ that assumes
the same values as the normalised density $\rho_n(r')$ at the boundaries of the
tesseroid ($r_1$ and $r_2$):

\begin{equation}
    \rho_l(r') =
    \frac{ \rho_n(r_2) - \rho_n(r_1) }{ r_2 - r_1 } (r' - r_1) + \rho_n(r_1),
    \label{eq:density-reference-line}
\end{equation}

\textit{Step 2}:
Evaluate the normalized and linear density functions on a range of $N$ radii between
$r_1$ and $r_2$.
We have opted for $N = 101$ but the specific value of $N$ is not critical to the
algorithm.

\textit{Step 3}:
Compute the absolute difference between the values of the linear and normalised density
functions:

\begin{equation}
    \Delta \rho (r') = | \rho_n(r') - \rho_l(r') |.
    \label{eq:density-abs-diff}
\end{equation}

\textit{Step 4}:
If the following inequality holds, the tesseroid will not be divided:

\begin{equation}
    \text{max}\{ \Delta \rho(r') \} \frac{L_r}{L_r^\text{orig}} \le \delta,
    \label{eq:delta-density}
\end{equation}

\noindent
in which $L_r$ is the radial dimension of the tesseroid being considered for division,
$L_r^\text{orig}$ is the radial dimension of the original tesseroid, and
$\delta$ is a positive constant henceforth called the \textit{delta ratio}.

\textit{Step 5}:
If inequality \ref{eq:delta-density} is not satisfied, then the tesseroid is split in
two parts at the radius $r_\text{max}$ at which the maximum absolute difference (Eq.
\ref{eq:density-abs-diff}) takes place.

\textit{Step 6}:
Repeat steps 1-6 for each smaller tesseroid produced in step 5.

\begin{figure*}
\centering
\includegraphics[width=\linewidth]
    {figures/density-based-discretization-algorithm.pdf}
\caption{
    Example application of the density-based discretization algorithm to a non-linear
    density function.
    (a) the normalised density function $\rho_n(r')$ (blue), current boundaries of the
    tesseroid (orange dots), and the linear density function $\rho_l(r')$ (orange line).
    The dashed red line represents the maximum density difference $\Delta \rho (r')$ at
    which the tesseroid would be divided (assuming that the inequality
    \ref{eq:delta-density} is not satisfied).
    (b) second iteration of the algorithm with a new linear density function and maximum
    density difference. The tesseroid would be divided at the depth indicated by the
    dashed red line.
    (c) third iteration of the algorithm.
    (d) final output of the density-based discretization, assuming that all four new
    tesseroids satisfy inequality \ref{eq:delta-density}.
}
\label{fig:density-discretization-algorithm}
\end{figure*}

Once all smaller tesseroids satisfy Eq. \ref{eq:delta-density},
each one is subjected to the adaptive
discretization algorithm described earlier to calculate their gravitational effects.

On the first iteration, the ratio $L_r/L_r^\text{orig} = 1$ because the tesseroid being
divided is the original one.
For future iterations, the ratio will be progressively smaller than one as the
tesseroids get smaller.
This is intended to limit the number of divisions to the ones that will
significantly reduce the numerical error:
dividing a large tesseroid with a small $\text{max}\{ \Delta \rho(r') \}$ would
improve the integration accuracy more than dividing a small tesseroid with a
higher $\text{max}\{ \Delta \rho(r') \}$.
We also do not divide tesseroids with $L_r < 1\ mm$ because any integration errors would
be negligible due to the small mass of the tesseroid..

The higher $\delta$ is, the fewer divisions will be made, and vice-versa.
Thus, it controls how many times the tesseroids will be divided based on the density
function and, indirectly, determines the accuracy and computation time of
numerical integration.
This raises the need to determine a maximum value of $\delta$ that
ensures an acceptable accuracy while minimising the computation time.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Determination of the distance-size and delta ratios}

The distance-size ration $D$ of the adaptive discretization and the delta ratio $\delta$
of the density-based discretization determine how many times each tesseroid will be
divided and thus indirectly control the numerical error of the integration.
Optimal values for $D$ and $\delta$ must be determined in order to ensure both
acceptable numerical accuracy and computation efficiency for the algorithm.

\citet{Uieda2016} compared the numerical integration of homogeneous density tesseroids
with the analytical solution of a spherical shell \citep{Mikuska2006,Grombein2013} in
order to obtain default values for the distance-size ratio $D$.
We will follow this idea but for our needs the spherical shell must
have the same density function of radius as our tesseroid model.
Analytical solutions for a variable density spherical shell are not present in the
literature and so they must be obtained first.
We derive the expressions for the gravitational fields of spherical shells with linear
and exponential density functions of radius in Appendix \ref{sec:shell}.

We perform comparisons between the analytical solutions for the spherical shell  and the
numerical integration results for linear and exponential density functions.
From these results, we generalize default values for $D$ and $\delta$ that ensure a
numerical error lower than 0.1\% of the spherical shell values.


\subsection{Linear Density}

Lets perform a comparison between our numerical model and the
analytical solution for a spherical shell with a linear density
function like the following one:

\begin{equation}
    \rho(r') = ar' + b.
\end{equation}

Secondly we can analyse how the density-based discretization algorithm
works in case of a linear density function.
Because the absolute difference defined on equation
\ref{eq:density-abs-diff} will always be zero, the discretization
inequation \ref{eq:delta-density} will never be satisfied.
Therefore, independently of the linear function proposed, the
density-based algorithm will never be applied, leaving the modified
adaptive discretization algorithm as the only mechanism to control the
accuracy of the numerical approximation.
That's why, for linear density scenarios, we only need to determine
the minimum value of $D$ needed in order to guarantee an acceptable
accuracy while ignoring the value of $\delta$.

In order to compare the numerical model with the analytical solution we
must build a spherical shell made of tesseroids.
We propose a mesh of $30^\circ \times 30^\circ$ tesseroids whose outer and
inner radii are the same ones as the spherical shell in order to compute
the gravitational potential, the vertical component of the gradient
($g_z$) and the diagonal components of the Marussi tensor ($g_{xx}$,
$g_{yy}$, $g_{zz}$) on four different grids: (1) a grid located at the
pole, (2) another one on the Equator, (3) one located at satellite
height and (4) a big grid of $30^\circ \times 30^\circ$.
More information about this grids can be found on Table
\ref{tab:grids}.

We will compute these gravitational fields on every point of the four
grids for different values of $D$, ranging from 0.5 to 10 with a step
of 0.5.
Then we will calculate the maximum difference between these results and the
value that the analytical solution assumes at the same height of the
computation grid.
Because the gravity fields generated by a tesseroid are approximated by
the effect of point masses, the numerical results may vary between
computation points at same height but at different latitude or
longitude.
That's why we will choose for comparison the maximum difference between the
results on every point of the grid and the analytical solution.

Finally, we will set the acceptable value of $D$ as the minimum value
at which the corresponding error of the numerical approximation is
lower than 0.1\%.

\begin{table}
\caption{
    Description of the synthetic grids on which the comparison of the
    numerical model against the analytical solutions for a spherical
    shell was done.
    This collection of grids tries to include every possible scenario
    on which the numerical model can present a different behaviour
    depending on the size of the grid, its location or its height over
    the Earth surface. Every grid consists in a set of 10$\times$10
    points.
}
\label{tab:grids}
\begin{tabular}{lcccc}
    Grid & Size & Lat. extension & Lon. extension & Height \\ \hline
    Pole & $1^\circ \times 1^\circ$ & $89^\circ - 90^\circ$ &
        $0^\circ - 1^\circ$ & 2km \\
    Equator & $1^\circ \times 1^\circ$ & $0^\circ - 1^\circ$ &
        $0^\circ - 1^\circ$ & 2km \\
    Satellite & $1^\circ \times 1^\circ$ & $89^\circ - 90^\circ$ &
        $0^\circ - 1^\circ$ & 260km \\
    Big Grid & $30^\circ \times 30^\circ$ & $60^\circ - 90^\circ$ &
        $0^\circ - 30^\circ$ & 2km \\
\end{tabular}
\end{table}

In order to perform the comparison, we proposed a thin and a thick
spherical shells with 1km and 35km of thickness, respectively, whose
outer radii are equal to the mean Earth radius.
On both cases we will suppose that the density assumes a value of
2670~kg/m$^3$ on the outer surface and 3300~kg/m$^3$ at the inner
radius:

\begin{equation}
    \rho(r') = ar' + c,
    \label{eq:density-linear}
\end{equation}
\noindent with
\begin{equation}
    a = -\frac{3300\text{kg/m$^3$} - 2670\text{kg/m$^3$}}{R_2 - R_1},
\end{equation}
\begin{equation}
    c = \frac{3300\text{kg/m$^3$} -
        2670\text{kg/m$^3$}}{R_2 - R_1} R +
        2670\text{kg/m$^3$},
\end{equation}

\noindent where $R$ = 6378.137 km is the mean Earth radius.

We have computed the percentage difference between the numerical model
with its corresponding analytical solution (equation
\ref{eq:shell-pot-linear}) for the thick and the thin spherical shell
on each of the four grids described in Table \ref{tab:grids}.
We can see the results for the potential, the vertical component of the
gradient $g_z$ and the $g_{zz}$ component of the Marussi tensor on
Figure \ref{fig:D-linear}.
We exclude the results corresponding to the other two diagonal
components of the tensor because they are similar to the ones obtained
for the $g_{zz}$, although they can be found on the repository.
\todo[inline]{chequear}

For the linear density case, we can observe that the calculation of the
potential and the $g_z$ component of its gradient needs a value of
$D=1$ and $D=2$, respectively, in order to ensure a numerical error
bellow the 0.1\% threshold.
On the other hand, the $g_{zz}$ computations show a noticeable
difference between the thin and the thick shell: the first one needs a
value of $D$ equal to 8 while the later only a $D$ of 3.5.
We will keep the more conservative result of $D$ equal to 8 in case of
computing the Marussi tensor components.

\begin{figure*}
\centering
\includegraphics[width=\linewidth]{figures/linear-D.pdf}
\caption{
    Differences between the gravity fields generated by the numerical model
    and the analytical solution for a thin and a thick spherical shell of 1km
    and 35km of thickness, respectively.
    Both models have the linear density defined on equation
    \ref{eq:density-linear}.
    The computations were performed on the four grids described in
    Table \ref{tab:grids}, for different values of the distance-size
    ratio $D$.
    Due to the linearity of the density function, the density-based
    discretization algorithm is not applied.
    If the difference is less than 0.1\%, we consider that the model
    has achieved an acceptable accuracy for the corresponding value of
    $D$.
    }
\label{fig:D-linear}
\end{figure*}


\subsection{Exponential Density}

Lets perform a similar comparison between the numerical model and
the analytical solution but now for a spherical shell with exponential
density.
On this scenario the problem is more complex due to the fact that the
density-based discretization will be certainly applied together with
the modified adaptive discretization algorithm.
This means that both the distance-size ratio $D$ and the delta ratio
$\delta$ must be simultaneously determined.

\subsubsection{$D$, $\delta$ space exploration}

From every combination of the $D$ and $\delta$ ratios we want to find
the one that produces a numerical error lower than the 0.1\% threshold
while keeping an effective computation, i.e. the ($D$, $\delta)$ pair
that produces the minimum number of discretizations and ensures an
acceptable numerical precision.
We can propose an heuristic method to perform this task: compute the
numerical error for every ($D$, $\delta$) points belonging to a grid on
the $D$, $\delta$ space and choose the pair that combines an
acceptable numerical error with an efficient computation.

Firstly, lets consider a decreasing exponential density function that
assumes the values of 2670 kg/m$^3$ and 3300 kg/m$^3$ on the shell's
outer and inner radii, respectively, that can be defined as follows:

\begin{equation}
    \rho(r') = A e^{-(r' - R)/b} + C,
\label{eq:density-exp}
\end{equation}
\noindent where
\begin{equation}
    A =
    (3300 \text{kg/m}^3 - 2670 \text{kg/m}^3)
    \left( e^{( R_2 - R_1 )/b} - 1 \right)^{-1},
\end{equation}
\begin{equation}
    C =
    2670 \text{kg/m}^3 - A,
\end{equation}

\noindent $R$ is the mean Earth radius and $b$ is a constant
that determines the variability of the function: a low value of $b$
increases the maximum slope of the density function.

Secondly, we propose a thick spherical shell with a thickness of 35km and
modelled by a mesh of $30^\circ \times 30^\circ$ tesseroids in order to
perform the exploration of the numerical error in the $D$, $\delta$
space.
We have assigned the density function proposed on equation
\ref{eq:density-exp} to our spherical shell model with a $b$ value of
1km, i.e. a highly varying density function.

Finally, we have computed the gravitational potential ($V$), the vertical
component of its gradient ($g_z$) and the $g_{zz}$ component of the
Marussi tensor on the big grid (see Table \ref{tab:grids}) by exploring
different values of $D$ and $\delta$.
These results were used to obtain the percentage difference between
them and their corresponding analytical solutions.

On Figure \ref{fig:grid-search} we show
the resulting percentage difference for each gravitational field.
The points inside the dotted lines are the ones that present a
numerical error lower than the 0.1\% threshold.
Our intention is to choose the one that produces the most efficient computation
and set it as the default values for $D$ and $\delta$.

\begin{figure}
\centering
\includegraphics[width=\linewidth]
    {figures/grid-search.pdf}
\caption{
    Numerical error exploration in the $D$, $\delta$ space.
    The percentage difference values were obtained from the comparison
    between the analytical solution and the numerical approximation of
    the gravitational fields ($V$, $g_z$ and $g_{zz}$) generated by a
    spherical shell with an exponential density as the one defined on
    equation \ref{eq:density-exp}.
    These comparison have been carried out with a spherical shell of
    35km of thickness, whose density function has a value of $b$ of 1km
    and the gravitational fields were computed on the big grid
    (defined in Table \ref{tab:grids}).
    The points inside the dashed line are the ones that present an
    error lower than 0.1\%.
    }
\label{fig:grid-search}
\end{figure}


\begin{figure}
\centering
\includegraphics[width=\linewidth]
    {figures/D-delta-grid-search.pdf}
\caption{
    $D$, $\delta$ space divided in three regions (A, B and C) based on
    the definitions of $D_\text{linear}$ and $\delta_p$ (see text for more
    information).
    Light grey points are the non-eligible ($D$, $\delta$) pairs
    belonging to the region A (with $D < D_\text{linear}$).
    Green points have acceptable numerical error (lower than 0.1\%),
    while the red ones represent those whose error is greater than the
    threshold.
    Dark grey points represent those from which we don't have a priori
    information about their numerical error.}
\label{fig:D-delta-grid-search}
\end{figure}

Because the algorithm is thought to work with default $D$ and $\delta$
values that ensures these two conditions for every density function,
the default value for $D$ cannot be lower than the one determined for
the linear function, which will be called $D_\text{linear}$.
That's why we can only choose the ($D$, $\delta$) points on which
$D \geq D_\text{linear}$.
Taking this fact into account we can divide the $D$, $\delta$ space in
two subregions: one with $D < D_\text{linear}$ and other with $D \ge
D_\text{linear}$.
We can ignore points belonging to the former one (region A on Figure
\ref{fig:D-delta-grid-search}) and focus on the latter (regions B and C on
Figure \ref{fig:D-delta-grid-search}).

From the $D \ge D_\text{linear}$ subregion we can explore the numerical
error of points with $D = D_\text{linear}$ and different values of
$\delta$.
We will call $\delta_p$ to the maximum $\delta$ at which the numerical
error is lower than the 0.1\% threshold while keeping
$D = D_ \text{linear}$.
Greater $\delta$ values than $\delta_p$ will produce computations with
high error (red points in Figure \ref{fig:D-delta-grid-search}), while
lower $\delta$ values than $\delta_p$ will produce more discretizations
leading to non-efficient computation (green dots under the
$(D_\text{linear}, \delta_p)$ point on Figure \ref{fig:D-delta-grid-search}).

With the definition of $\delta_p$ in mind we can subdivide the
subregion in two: one with points with $\delta \le \delta_p$ (region B
on Figure \ref{fig:D-delta-grid-search}) and other with points with
$\delta > \delta_p$ (region C on Figure \ref{fig:D-delta-grid-search}).

Every point in the subregion with $\delta \le \delta_p$ (region B on
Figure \ref{fig:D-delta-grid-search}) will have a numerical error lower
than the 0.1\% threshold, but they will always produce more
discretizations than the ($D_\text{linear}$, $\delta_p$) point leading
to non-efficient computations.
It's worth remembering that a lower $\delta$ or a greter $D$ will
produce more discretizations, increasing the accuracy but also the
computation time.

On the other hand, we have no a priori information about the numerical
error of points with $\delta > \delta_p$ (region C on
Figure \ref{fig:D-delta-grid-search}).
Nevertheless, the numerical error exploration shown on
Figure \ref{fig:grid-search} doesn't present any
point in this region with error lower than the threshold.
Even though we are analysing a single case, it proves that no point in
region C is eligible as default ($D$, $\delta$) pair because it should
ensure numerical accuracy for every exponential density scenario.

In conclusion, the ($D$, $\delta$) point that minimises the number of
discretizations while keeping an acceptable numerical error under the
0.1\% threshold is the one whose ratio $D$ is equal to
$D_\text{linear}$ and its delta ratio is $\delta_p$.

\subsubsection{Delta ratio determination}

In order to determine a default value of $\delta$ that ensures an
acceptable accuracy for every exponential density case we have
performed comparisons between the numerical model and the analytical
solutions, keeping the distance-size ratio $D$ equal to the values
obtained for the linear density case while exploring different values of
$\delta$.

Firstly, we have considered the same spherical shell models we have
used in the linear density case: a thin one (1km of thickness) and a
thick one (35km of thickness) composed by $30^\circ \times 30^\circ$
tesseroids.
But in this case, we assigned an exponential density function like the
one shown in equation \ref{eq:density-exp} to each shell, choosing
a few values of $b$ in order to explore different density
variations.

Finally, we have computed the gravitational potential ($V$), the
vertical component of its gradient ($g_z$) and the $g_{zz}$ component of
the Marussi tensor on the big grid (see Table \ref{tab:grids}) and
calculated the percentage difference between these numerical results and
their corresponding analytical solutions.
Our intention is to set the default $\delta$ as the highest value whose
numerical error is bellow the $0.1\%$ threshold.

On Figure \ref{fig:delta-exponential} we show the density functions
used on each comparison and the resulting percentage difference for each
gravitational field.
The first column shows the results for the thin spherical shell, while the
second one shows the ones corresponding to the thick shell.
From these we can conclude that a $\delta = 0.2$ is needed in order to
achieve an acceptable numerical error for the computation of the
potential and the $g_z$ component.
Because the same comparison using the other components of the gradient ($g_x$
and $g_y$) could not be carried out, we will extrapolate this result
setting a default $\delta = 0.2$ for their computation.

On the other hand, the comparison with the $g_{zz}$ component of the
Tensor shows a difference between the thin and the thick spherical
shell: the former needs a $\delta = 0.2$, but the latter requires a
$\delta = 0.01$.
In order to guarantee a good accuracy for every case, we will keep the
more conservative value of $\delta = 0.01$ for the computation of the
Marussi tensor components.

\begin{figure*}
\centering
\includegraphics[width=\linewidth]{figures/exponential-delta.pdf}
\caption{
    Density functions used in the $\delta$ ratio determination and the
    differences between the gravitational fields generated by the
    numerical model and the analytical solution for a thin and a thick
    spherical shell of 1km adn 35km of thickness, respectively, both
    with the exponential density defined on equation
    \ref{eq:density-exp}.
    A few values of the constant $b$ were used in order to test the
    numerical model for different density variations.
    The computations were performed on the big grid described in
    Table \ref{tab:grids}, with fixed values of the distance-size ratio
    $D$ obtained for in the linear density case ($D=1, 2, 8$ for the
    potential, gradient components and tensor components, respectively)
    and different values of the $\delta$ ratio.
    If the difference is less than 0.1\%, we consider that the model
    has achieved an acceptable accuracy for the corresponding value of
    $\delta$.
    }
\label{fig:delta-exponential}
\end{figure*}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Implementation}

In order to perform the determinations of the distance-size and the
delta ratio, we have developed a Python code that implements the
discretization algorithms and the GLQ to finally compute the
gravitational fields.

It is based on the pre-existing code developed by \citet{Uieda2016} (and
included in Fatiando a Terra v.0.5, \citet{Uieda2013}) that computes
the gravitational effects of tesseroids with homogeneous density.
Our implementation keeps the the homogeneous tesseroid calculation and
the modified adaptive discretization algorithm while incorporates the
new variable density computations with the density-based discretization
algorithm.
On their software, \citet{Uieda2016} have optimised the more time
consuming functions through the Numba compiler.
In contrast, we have decided to develop our new library in Cython
language due to difficulties when passing a Python function as argument
to precompiled Numba methods.

This new code is freely available under the BSD 3-clause open-source
license and makes use of the pre-existing classes and functions of
Fatiando a Terra v0.5 in order to define single tesseroid or meshes of
them.
It can be downloaded from ...
\todo[inline]{include repo url}

\todo[inline]{I'm thinking to remove the speed comparison}

\subsection{Speed Comparison}

We have recorded the computation times for the gravity potential, the gradient component $g_z$ and the Marussi tensor component $g_{zz}$ generated by a single tesseroid model ($35$km of thickness) with homogeneous, linear and exponential density (with $b=50$km) at different heights. Then we calculated the ratio between these computation times:

\begin{equation}
    \text{Computation Times Ratio} =
        \frac{\Delta t_\text{variable}}{\Delta t_\text{homogeneous}},
    \label{eq:computation-times-ratio}
\end{equation}

\noindent where $\Delta t_\text{homogeneous}$ and $\Delta t_\text{variable}$ are the computation times corresponding to the homogeneous model and to the variable density ones (linear and exponential).

On Figures \ref{fig:speed-comparison}a and \ref{fig:speed-comparison}b we can see the results of these comparison.
In the linear density case the density-based discretization algorithm is not applied because the inequation \ref{eq:delta-density} is never satisfied.
For this reason, the homogeneous density model is up to 5 times faster than the variable density one in this case.
On the other hand, the density-based discretization algorithm makes the computation slower: up to 20 times slower than the homogeneous density code.
Nevertheless, this increase in the computation time pays off with a guarantee\todo[inline]{guarantee is a noun?} on its accuracy.

\begin{figure}
\centering
\includegraphics[width=0.9\linewidth]{figures/speed-comparison.pdf}
\caption{Computation time ratio between a single tesseroid model with variable and with homogeneous density at different heights (defined in equation \ref{eq:computation-times-ratio}) for (a) a linear and (b) an exponential density.}
\label{fig:speed-comparison}
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Example with real data}

Besides the determination of the distance-size and the delta ratio, we
wanted to illustrate how the algorithm performs under a real data model.
For this task we have chosen the Neuqu\'en Basin: a sedimentary basin
located to the east of the Andes, between 32$^\circ$S and 40$^\circ$S latitude
(see Figure \ref{fig:neuquen-basin}a), that includes continental and marine
siliciclastics, carbonates and evaporites accumulated over the Jurassic and
the Cretaceous constituting a stratigraphic record up to 5000m of depth
\citep{Howell2005}.

\begin{figure*}
\centering
\includegraphics[width=\linewidth]{figures/neuquen-basin.pdf}
\caption{
    Forward model example with real data: Nequ\'en sedimentary modelled
    through tesseroids with exponential density.
    (a) Topography of Neuqu\'en Basin (in km),
    (b) thickness of the sedimentary basin (in meters),
    (c) density function used to model the basin (depth in km and density in
    kg/m$^3$),
    (d)-(l) computed gravity fields: potential $V$ (in J/kg), gradient
    components $g_x$, $g_y$ and $g_z$ (in mGal) and Marussi tensor components
    (in Eötvös), calculated at 50km of height over the ellipsoid.}
\label{fig:neuquen-basin}
\end{figure*}

The thickness of the sediment pack was obtained from \citet{Heine2007}.
We managed to produce a regular grid with a resolution of 0.05$^\circ$ on both
longitude and latitude directions with one value of thickness on each node
(see Figure \ref{fig:neuquen-basin}(b)).

In order to compute the gravity fields generated by this basin we created a
mesh of tesseroids, each one located on one of the nodes of the grid, with
dimensions of 0.05$^\circ$ $\times$ 0.05$^\circ$ and depth equal to the
thickness of the basin on the corresponding node.

We must also define a density function for the entire model.
\citet{Sigismondi2012} measured a minimum and maximum density contrast for
the Neuqu\'en basin of -412kg/m$^3$ and -275kg/m$^3$, respectively.
So we have chosen, for this specific example, an exponential density (like the
one in equation \ref{eq:density-exp}) that assumes the minimum value on the
surface and the maximum at 5858m, i.e. the bottom of the basin, with a value
of $b$ equal to 2km.
This density function can be seen on Figure \ref{fig:neuquen-basin}(c).

We have computed the gravity potential $V$, the gradient components $g_x$,
$g_y$ and $g_z$, and the Marussi tensor components $g_{xx}$, $g_{xy}$,
$g_{xz}$, $g_{yy}$  and $g_{zz}$ on a computation grid of 159$\times$163 nodes
with a 0.05$^\circ$ spacing on both longitude and latitude directions at a
50km height over the reference ellipsoid.
The resulting gravity fields can be seen in Figures
\ref{fig:neuquen-basin}(d)-(l).
We have excluded the other components of the Marussi tensor from the Figure,
although they can be found in the repository.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Conclusions}

We have developed a new methodology that computes the gravitational fields
generated by a tesseroid with continuously variable density in depth.
It numerically solves the integrals that define the gravitational potential,
its gradient and the Marussi tensor components through the Gauss-Legendre
Quadrature (GLQ), which essentially consists in approximating the
gravitational fields of the tesseroids with the effect of point masses located
on nodes of the Quadrature.

Instead of enhancing the accuracy of the method by increasing the order of the
GLQ on each integration, we make use of the pre-existing modified adaptive
discretization algorithm and a new density-based discretization algorithm.

The former one divides the tesseroid by half if the ratio of the distance to
the computation point and its size is lower than a predefined distance-size
ratio $D$.
This algorithm is introduced in order to minimise the error when the
computation point is close to the tesseroid, in which case the effect of the
point masses becomes more noticeable and the approximation lose precision.
Following this idea, we can summarise that the distance-size ratio $D$
controls the accuracy of the method: a higher value of $D$ generates more
divisions of the tesseroids, thus more point masses, what leads to a more
precise approximation.
Nevertheless, this algorithm is not sufficient to guarantee the accuracy of
the method in case of tesseroid with variable density.

For this reason we have developed a density-based discretization algorithm that
divides the tesseroid on the radius at which the \emph{maximum variation} of
the density function takes place, only if a certain inequation that relates
this \emph{maximum variation} with a predefined delta ratio $\delta$ holds.
The number of subdivisions is indirectly controlled by this delta
ratio $\delta$, and thus the accuracy of the computation.
This new algorithm is intended to minimise the error due to the inability of
the GLQ to produce precise approximations in case of highly varying density:
the information about the density function is summed up with the values that
it assumes at the node of the quadrature.
Increasing the subdivisions of the tesseroid where the \emph{maximum
variation} of the density takes place becomes an efficient way to reduce this
kind of error.

Because there is no direct relation between the values assigned to $D$ and
$\delta$ with the error of the computation, we had to empirically determine
the minimum value of $D$ and the maximum value of $\delta$ that produce an
acceptable accuracy for each gravitational field, while maintaining an
efficient computation.
The default values of $D$ and $\delta$ must produce accurate computations for
most continuous and smooth densities, that's why we have chosen two density
functions in order to establish them: a linear and an exponential one.

In the linear density case, the densty-based discretization algorithm is not
applied due to how it's build, so only a default value of $D$ had to be
determined.
By comparing the analytical solutions of the gravitational fields generated by
a spherical shell with the ones produced by the numerical model for different
values of $D$, we have obtained default values for the distance-size ratio of
1, 2 and 8 for the potential, its gradient and the Marussi tensor components,
respectively.
From these comparisons we can guarantee a precision of 0.1\% or greater on the
computations of the gravitational fields generated by any tesseroid with a
linear density.

The exponential density case is more complex, due to the fact that both $D$
and $\delta$ must be determined simultaneously.
We have explored regular gridded points in the $D$, $\delta$ space and
computed the percentage difference between the analytical solutions for a
spherical shell and the numerical model.
We had to take into account that the $D$ values cannot be lower than the ones
determined for the linear density case due to the fact that they must
guarantee acceptable accuracy for every continuous density function, including
the linear one.
From these comparisons we have concluded that the more efficient computations
take places when the $D$ values obtained in the linear density scenario are
used, i.e. the minimum ones.
This can be understood in terms of which kind of discretization produces more
subdivisions: a higher $D$ may produce more discretizations than a lower
$\delta$ because the first one divides the tesseroid in the radial, longitude
and latitude directions, while the latter only divides it in the radial
direction.
In conclusion, we found out that keeping the $D$ values as the ones obtained
for the linear density case, a $\delta = 0.2$ is needed for the computation of
the potential and its gradient components, while a $\delta = 0.01$ must be
used for the Marussi tensor components in order to ensure a 0.1\% precision.

In order to implement this new methodology we have developed a Python code
that carries out both discretization algorithms and the gravitational field
computation through the GLQ. It's freely available under the BSD 3-clause
open-source license and can be downloaded from
\todo[inline]{add repo url}

Finally, we have shown how this new method performs under a real data example:
we have computed the gravitational fields generated by the Neuqu\'en
sedimentary basin through a tesseroid model with an increasing exponential
density in depth on a regular grid at a computation height of 50km over the
reference ellipsoid.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Acknowledgments}

We are indebted to the developers and maintainers of the open-source
software without which this work would not have been possible.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\bibliographystyle{gji}
\bibliography{references}

\appendix

\section{Analytical Solutions for Spherical Shell}
\label{sec:shell}

\begin{figure}
\centering
\includegraphics[width=0.7\linewidth]{figures/spherical-shell.pdf}
\caption{
    Spherical shell with inner and outer radii $R_1$ and $R_2$, respectively.
    The computation point $Q$ is located on the $z$ axis at a distance $r$ from
    the origin of the coordinates system.
    For our purposes we will assume that $Q$ is outside of the shell,
    i.e. $r > R_2$.
}
\label{fig:spherical-shell}
\end{figure}

Consider a spherical shell with inner radius $R_1$ and outer radius $R_2$,
whose density is a function $\rho(r')$ of the radial coordinate
(Fig. \ref{fig:spherical-shell}).
The gravitational potential generated by the shell on an arbitrary external
point $Q$ can be written as follows:

\begin{equation}
    V_\text{sh}(\phi, \lambda, r) = G
    \int\limits_0^{2\pi}
    \int\limits_{-\frac{\pi}{2}}^\frac{\pi}{2}
    \int\limits_{R_1}^{R_2}
    \frac{\rho(r')}{\ell} {r'}^2 \cos\phi' \,
    dr' d\phi' d\lambda',
\end{equation}

\noindent where $\ell$ is defined in equation \ref{eq:ell}.

For $Q$ located along the $z$ axis (i.e., $\phi=90^\circ$) at a distance $r$ from the
origin, equation \ref{eq:ell} simplifies to:

\begin{equation}
    \ell = \sqrt{r'^2 + r^2 - 2 r r' \sin\phi'}.
\end{equation}

\noindent
Because of the rotational symmetry along the $z$ axe, the integration in $\lambda'$ is
straightforward:

\begin{equation}
    V_\text{sh}(r) = 2\pi G
    \int\limits_{-\frac{\pi}{2}}^\frac{\pi}{2}
    \int\limits_{R_1}^{R_2}
    \frac{\rho(r') {r'}^2 \cos\phi'}{\sqrt{r'^2 + r^2 - 2 r r' \sin\phi'}}
    \, dr' d\phi',
\end{equation}

\noindent
while the integration in $\phi'$ can be performed independently of the density function.
Making use of SymPy \citep{sympy2017}, a Python library for symbolic mathematics, we
obtained the following expression for the potential:

\iftwocol{
\begin{equation}
    \begin{split}
        V_\text{sh}(r) = 2\pi G
        \int\limits_{R_1}^{R_2}
        \Big[ & \sqrt{r^2 + r'^2 + 2rr'} - \\
        & \sqrt{r^2 + r'^2 - 2rr'}
        \Big] \frac{r'\rho(r')}{r} \, dr'.
    \end{split}
\label{eq:shell-pot-sqrts}
\end{equation}
}{
\begin{equation}
    V_\text{sh}(r) = 2\pi G
    \int\limits_{R_1}^{R_2}
    \Big[ \sqrt{r^2 + r'^2 + 2rr'}  -
    \sqrt{r^2 + r'^2 - 2rr'}
    \Big] \frac{r'\rho(r')}{r} \, dr'.
\label{eq:shell-pot-sqrts}
\end{equation}
}

Because the computation point $Q$ is outside of the shell, $r > r'$ and the square roots
in equation \ref{eq:shell-pot-sqrts} simplify to

\begin{equation}
    \sqrt{r^2 + r'^2 + 2rr'} = |r + r'| = r + r',
\end{equation}

\begin{equation}
    \sqrt{r^2 + r'^2 - 2rr'} = |r - r'| = r - r',
\end{equation}

\noindent which leads to the following expression for the potential:

\begin{equation}
    V_\text{sh}(r) = \frac{4\pi G}{r}
    \int\limits_{R_1}^{R_2} {r'}^2 \rho(r') \, dr'.
\label{eq:shell-pot}
\end{equation}

The gradient and the Marussi tensor of potentials that
depends solely on $r$ have only a few non zero components: the vertical
component of the gradient ($g_z$) and the diagonal components of the
tensor ($g_{xx}$, $g_{yy}$, $g_{zz}$).
Following \citet{Grombein2013}:

\begin{equation}
    g_z(r) = \frac{V_\text{sh}(r)}{r},
\end{equation}

\begin{equation}
    g_{xx}(r) = g_{yy}(r) = -\frac{V_\text{sh}(r)}{r^2}
\end{equation}

\begin{equation}
    g_{zz}(r) = \frac{2V_\text{sh}(r)}{r^2}.
\end{equation}

From Eq. \ref{eq:shell-pot} we can obtain expressions for gravitational potential for
different density functions.
For a linear density function

\begin{equation}
    \rho(r') = ar' + b\ ,
\end{equation}

\noindent
the gravitational potential at any external point is

\begin{equation}
    V_\text{sh}^\text{lin}(r) = \pi G \left[
    a \frac{R_2^4 - R_1^4}{r} +
    b \,\frac{4}{3} \frac{R_2^3 - R_1^3}{r} \right].
    \label{eq:shell-pot-linear}
\end{equation}

\noindent The first term on this equation reproduces the potential generated
by a spherical shell with variable density $\rho(r') = ar'$, while the second
term constitutes the potential generated by a spherical shell with homogeneous
density $\rho = b$ \citep{Mikuska2006,Grombein2013}.

An exponential density function that assumes the values of $\rho_\text{out}$ and
$\rho_\text{in}$ on the shell's outer and inner surfaces, respectively, can be defined
as follows:

\begin{equation}
    \rho(r') = A e^{-(r' - R)/b} + C,
\label{eq:density-exp}
\end{equation}

\noindent where

\begin{equation}
    A = (\rho_\text{in} - \rho_\text{out})
        \left( e^{( R_2 - R_1 )/b} - 1 \right)^{-1},
\end{equation}

\begin{equation}
    C = \rho_\text{out} - A,
\end{equation}

\noindent $R$ is the mean Earth radius, and $b$ is a constant
that determines the variability of the function: a low value of $b$
increases the maximum slope of the density function.

The analytical solution of the gravitational potential generated by a
spherical shell with a density function given by equation
\ref{eq:density-exp} is

\iftwocol{
\begin{equation}
    \begin{split}
        V_\text{sh}^\text{exp}(r) = \frac{4\pi G}{r}
        Ab
        \Big[
        & (R_1^2 + 2R_1 b + 2b^2)e^{-\frac{R_1 - R}{b}} - \\
        & (R_2^2 + 2R_2 b + 2b^2)e^{-\frac{R_2 - R}{b}}
        \Big] + \\
        & \frac{4 \pi G}{3 r} C (R_2^3 - R_1^3).
    \end{split}
\label{eq:shell-pot-exp}
\end{equation}
}{
\begin{equation}
    V_\text{sh}^\text{exp}(r) = \frac{4\pi G}{r}
    Ab \, e^\frac{R}{b}
    \Big[
    (R_1^2 + 2R_1 b + 2b^2)e^{-\frac{R_1}{b}} -
    (R_2^2 + 2R_2 b + 2b^2)e^{-\frac{R_2}{b}}
    \Big] +
    \frac{4 \pi G}{3 r} C (R_2^3 - R_1^3).
\label{eq:shell-pot-exp}
\end{equation}
}


\end{document}


# Gravity fields calculation in spherical coordinates using Tesseroids with variable density

by
Santiago R. Soler,
Agustina Pesce,
Leonardo Uieda,
Mario E. Gimenez

This paper has been submitted for publication in the *Geophysical Journal International*.

We introduce a novel methodology for gravity forward modeling in spherical coordinates
using tesseroids (spherical prisms) with variable densities in depth. It builds on
previous work by the authors and introduces a new density-based discretization algorithm
to ensure the accuracy of the numerical integration.

![Neuquén Basin application](neuquen-basin-application.jpg)
*Application of the methodology to the Neuquén basin in the Andes.*

## Abstract

We present a new methodology to compute the gravitational fields generated by tesseroids
(spherical prisms) whose density varies continuously with depth according to an
arbitrary function. It approximates the gravitational fields through the Gauss-Legendre
Quadrature along with two discretization algorithms that automatically control its
accuracy by adaptively dividing the tesseroid into smaller ones. The first one is a
preexisting adaptive discretization algorithm that reduces the errors due to the
distance between the tesseroid and the computation point. The second is a new
density-based discretization algorithm that decreases the errors introduced by the
variation of the density function with depth. The amount of divisions made by each
algorithm is indirectly controlled by two parameters: the distance-size ratio and the
delta ratio. We have obtained analytical solutions for a spherical shell with radially
variable density and compared them to the results of the numerical model for linear and
exponential density functions. These comparisons allowed us to obtain optimum values for
the distance-size and delta ratios that yield an accuracy of 0.1\% of the analytical
solutions. The resulting optimal values of distance-size ratio for the gravitational
potential, its gradient, and Marussi tensor are 1, 2 and 8, respectively. A delta ratio
of 0.2 is needed for the computation of the gravitational potential and its gradient
components, while a value of 0.01 must be used for the Marussi tensor components.
Lastly, we apply this new methodology to model the Neuquén Basin, a foreland basin in
Argentina with a maximum depth of over 5000 m, using an exponential density function.


## Reproducing the results

You can download a copy of all the files in this repository by cloning the
[git](https://git-scm.com/) repository:

    git clone https://github.com/pinga-lab/tesseroid-variable-density.git

or [click here to download a zip archive](https://github.com/pinga-lab/tesseroid-variable-density/archive/master.zip).

All source code used to generate the results and figures in the paper are in
the `code` folder. There you can find the Python and Cython codes that
performs the gravity field calculations and Jupyter notebooks that tests
those codes.

In `data` you can find the precalculated results of the notebooks,
so you can remake the plots under `manuscript/figures` without the need to rerun the
time consuming cells that generates those results.

The sources for the manuscript text and figures are in `manuscript`.

See the `README.md` files in each directory for a full description.

The calculations and figure generation are all run inside
[Jupyter notebooks](http://jupyter.org/).
See sections below for instructions on executing the code.


### Setting up your environment

You'll need a working Python **2.7** environment with all the standard
scientific packages installed (numpy, scipy, matplotlib, etc).  The easiest
(and recommended) way to get this is to download and install the
[Anaconda Python distribution](http://continuum.io/downloads#all).
Make sure you get the **Python 2.7** version.

#### Manual installation

You'll also need to install version 0.5 of the
[Fatiando a Terra](http://www.fatiando.org/) library.
See the install instructions on the website.

Other dependencies needed to reproduce the results are:

* cython
* basemap
* sympy

You can install it through the conda package manager (included in Anaconda):

```
conda install cython basemap sympy
```

#### Installing through conda environment

Instead of manually install all the dependencies, they can all be automatically
installed using a conda environment.

1. Change directory to the cloned git repository:
    ```
    cd tesseroid-variable-density
    ```
1. Create a new conda environment from the environment.yml file:
    ```
    conda env create -f environment.yml
    ```
1. Activate the new enviroment:
    * Windows: `activate tesseroid-variable-density`
    * Linux and MacOS: `source activate tesseroid-variable-density`

For more information about managing conda environments visit this
[User Guide](https://conda.io/docs/user-guide/tasks/manage-environments.html)

#### Compiling Cython code

The code that calculates the gravity fields generated by tesseroids with
variable density can be found in code/tesseroid-density. Because it's written
in Cython, you must compile it in order to call its functions. You can do it
with make command:

```
cd tesseroid-variable-density/code/tesseroid_density
make
```

> **Windows users:** It is highly recommended that you install the bash shell
> to run code and produce the results here.
> You can download bash for Windows at http://git-for-windows.github.io/.
> Install the "Git for Windows SDK" that will come with bash and `make` as
> well.

### Running the code

To execute the code in the Jupyter notebooks, you must first start the
notebook server by going into the repository folder and running:

```
jupyter notebook
```

This will start the server and open your default web browser to the Jupyter
interface. In the page, go into the `code` folder and select the
notebook that you wish to view/run.

The notebook is divided in cells (some have text while other have code).
Each cell can be executed using `Shift + Enter`.
Executing text cells does nothing and executing code cells runs the code
and produces it's output.
To execute the whole notebook, run all cells in order.


## License

All source code is made available under a BSD 3-clause license.  You can freely
use and modify the code, without warranty, so long as you provide attribution
to the authors.  See `LICENSE.md` for the full license text.

The manuscript text is not open source. The authors reserve the rights to the
article content, which is currently submitted for publication in the
Geophysical Journal International.
